Bootloader für HMW Homebrew devices======================================
Idee
-------Der Bootloader für die HMW Homebrew devices ermöglicht es, Geräte, die auf der Arduino-Plattform basieren und an einen RS485-Bus (HMW-Protokoll) angeschlossen sind, über die Arduino-IDE zu flashen.Funktionsprinzip
-------------------Der HMW-Bootloader basiert auf dem Standardbootloader des Arduino (Optiboot), wobei jedoch alle Befehle und Daten in das HMW-Protokoll verpackt werden (HMW-Zentrale sollte dadurch keine Fehler auf dem Bus erkennen).Um die „normalen“ Flashbefehle der Arduino-IDE in das spezielle HMW-Protokoll zu verpacken und auf den HM485-Bus zu legen, wird ein Programmiergerät benötigt, das aus einem normalen Arduino besteht. An diesen Arduino wird lediglich ein RS485-Transmitter angeschlossen (Stardard-Pinbelegung: Rx: 2, Tx: 3, Tx-Enable: 4). Zusätzlich muss die Resetleitung über einen Kondensator (22µF haben sich bewährt) mit Masse verbunden werden. Dieser Kondensator verhindert, dass der Arduino (das Programmiergerät) beim Flashen über die IDE geresettet wird und selbst in den Bootloader geht.Da an dem HM485-Bus in der Regel mehrere Clients angeschlossen sind, muss dem Programmiergerät vor dem Flashen die ID des entsprechenden Clients übergeben werden.Bootloader-Installation
--------------------------Die Dateien aus dem Bootloader Ordner werden im Verzeichnis der Arduino-Installation abgelegt (z.B. C:\Program Files (x86)\Arduino\hardware\arduino). Nach einen Neustart der Arduino-IDE kann unter Tools/Boards das Device „Homematic wired“ ausgewählt werden. Über Tools/Bootloader installieren wird anschließend der HMWBootloader auf den Arduino geflasht (AVR-Programmiergerät notwendig. Funktioniert genauso wie die Installation des originalen Bootloaders. Hilfe hierzu sollte es im Netz reichlich geben).Der Arduino mit dem HMW-Bootloader kann anschließend mit einem RS485-Transmitter an den HMW-Bus angeschlossen werden (Standard-Pinbelegung: Rx: 0, Tx: 1, Tx-Enable-Pin: 4). Die Kommunikation läuft über den Hardware-UART.Flashen
----------1. Programmiergerät (der „normale“ Arduino) und der Client mit dem Bootloader müssen an den HM485-Bus angeschlossen sein.2. Auf das Programmiergerät wird das Projekt „hmwProgrammer“ geflasht (ganz normal über die Arduino-IDE, hier ist noch der originale Bootloader vorhanden). Zum Flashen den Kondensator entfernen oder zum richtigen Zeitpunkt einen manuellen Reset über die Reset-Taste ausführen, damit der Arduino in den Bootloader geht. Nach dem Flashen den Kondensator wieder einsetzen.3. Projekt öffnen, das auf den HMW-Client geflasht werden soll.4. Unter Tools/Boards „Homematic wired“ auswählen5. Unter Tools/Serieller Port den Port des Programmiergeräts (Arduino) auswählen6. Serial Monitor aufrufen und einen Reset auf dem Programmiergerät ausführen (durch den eingesetzten Kondensator wird der Reset nicht automatisch beim Öffnen des Serial Monitors ausgeführt. Reset ist auch nicht zwingend notwendig, sorgt aber dafür, dass der Begrüßungstext und die Aufforderung zur Eingabe der ClientID angezeigt werden)7. Bei der Abfrage der ClientID „0000ABCD“ eingeben (die ID ist im Bootloader leider noch fest vergeben. Ist das größte ToDo…)8. Möglicherweise wechselt der Client nicht automatisch in den Bootloader (hängt davon ab, ob bereits eine entsprechende Applikation geflasht ist). Evtl. fordert das Programmiergerät zu einem Hardware-Reset auf9. Upload wählen, Abwarten und Daumen drücken
Anpassen des Bootloaders
---------------------------Die Quelldateien liegen ebenfalls im Bootloader-Ordner. Da der Bootloader an einer bestimmten Adresse im Controller liegen muss ist ein spezielles Linker-File notwendig, so dass der Bootloader selbst nicht über die Arduino-IDE bearbeitet werden kann. Wer den Bootloader weiter entwickeln oder anpassen möchte, sollte also direkt das .c-File editieren. Kompiliert wird das Ganze, indem auf der Konsole im Verzeichnis des Bootloaders der Befehl "omake atmega328" ausgeführt wird (vorher das .hex und .lst-File löschen, sonst läufts nicht).Offene Punkte
----------------Die ClientId ist im Bootloader fest vorgegeben, d.h. um den Clients eindeutige IDs zu geben, müsste der Source-Code des Bootloaders für jeden Client angepasst und neu kompiliert werden...
Möglichkeiten für individuelle IDs wären
	a) nachträgliche Vergabe der ID manuell
	b) an jeden Client einem 1-wire Sensor anschließen - die 1-wire Sensoren haben angeblich alle eine eindeutige ID, die vom Client übernommen werden könnte
	c) generierung einer zufälligen ID, indem das Rauschen eines AD-Kanals ausgenutzt wird
	d) Zeitabstand auswerten (z.B. vom Reboot bis zum ersten Tastendruck oder dem ersten Empfang einer Busnachricht)
